// Generated by CoffeeScript 1.6.1
(function() {
  var app, data, visuals;

  app = angular.module("nutrients-per-calorie", ["food-visuals", "food-data"]);

  app.config(function($routeProvider) {
    return $routeProvider.when("/compare", {
      templateUrl: "partials/compare.html",
      controller: "CompareCtrl",
      reloadOnSearch: false
    }).when("/compare/:foods", {
      templateUrl: "partials/compare.html",
      controller: "CompareCtrl",
      reloadOnSearch: false
    }).when("/foods", {
      templateUrl: "partials/foods.html",
      controller: "FoodsCtrl",
      reloadOnSearch: false
    }).when("/foods/:food", {
      templateUrl: "partials/foods.html",
      controller: "FoodsCtrl",
      reloadOnSearch: false
    }).when("/nutrients", {
      templateUrl: "partials/nutrients.html",
      controller: "NutrientsCtrl",
      reloadOnSearch: false
    }).when("/nutrients/:nutrient", {
      templateUrl: "partials/nutrients.html",
      controller: "NutrientsCtrl",
      reloadOnSearch: false
    }).when("/about", {
      templateUrl: "partials/about.html"
    }).otherwise({
      redirectTo: "/compare"
    });
  });

  app.controller("MainCtrl", function($scope, $location, FoodData, ComparePage, FoodsPage, NutrientsPage) {
    $scope.foodData = FoodData;
    return $scope.navLinks = _.extend([
      {
        text: "Compare",
        getPath: ComparePage.getPath
      }, {
        text: "Foods",
        getPath: FoodsPage.getPath
      }, {
        text: "Nutrients",
        getPath: NutrientsPage.getPath
      }, {
        text: "About",
        getPath: function() {
          return "#/about";
        }
      }
    ], {
      isActive: function(navLink) {
        return _.contains(navLink.getPath(), $location.path());
      }
    });
  });

  app.factory("ComparePage", function($location, FoodData) {
    var data;
    return data = {
      query: {
        text: "",
        includeFoodGroups: false
      },
      selectedFoods: [],
      isSelected: function(food) {
        return !!_.find(this.selectedFoods, function(f) {
          return f.NDB_No === food.NDB_No;
        });
      },
      toggle: function(food) {
        if (this.isSelected(food)) {
          return this.selectedFoods = _.reject(this.selectedFoods, function(f) {
            return f.NDB_No === food.NDB_No;
          });
        } else {
          return this.selectedFoods = _.union(this.selectedFoods, _.clone(food));
        }
      },
      clear: function() {
        var food, _i, _len, _ref;
        _ref = this.selectedFoods;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          food = _ref[_i];
          FoodData.findFoodById(food.NDB_No).selected = false;
        }
        return this.selectedFoods = [];
      },
      basePath: "#/compare",
      updatePath: function() {
        return window.location.hash = this.getPath();
      },
      getPath: function(foods) {
        if (foods == null) {
          foods = data.selectedFoods;
        }
        return data.basePath + data.getSearch(foods);
      },
      getSearch: function(foods) {
        if (foods == null) {
          foods = data.selectedFoods;
        }
        if (foods.length) {
          return "?foods=" + _.pluck(foods, "NDB_No").join(",");
        } else {
          return "";
        }
      },
      getPathWithFoodAdded: function(food) {
        var foods;
        if (food) {
          foods = _.clone(this.selectedFoods);
          if (!_.find(foods, function(f) {
            return f.NDB_No === food.NDB_No;
          })) {
            foods.push(food);
          }
          return this.getPath(foods);
        } else {
          return this.basePath;
        }
      }
    };
  });

  app.controller("CompareCtrl", function($scope, $routeParams, FoodData, ComparePage) {
    FoodData.afterLoading($scope, function() {
      if ($routeParams.foods) {
        return ComparePage.selectedFoods = _.clone(FoodData.findFoodsById($routeParams.foods.split(",")));
      } else {
        return ComparePage.selectedFoods = [];
      }
    });
    $scope.compare = ComparePage;
    return $scope.$watch("compare.selectedFoods", function(newVal, oldVal) {
      FoodData.calculateRelativeValues(newVal);
      if (FoodData.loaded) {
        return ComparePage.updatePath();
      }
    });
  });

  app.factory("FoodsPage", function($location) {
    var data;
    return data = {
      query: {
        text: "",
        includeFoodGroups: false
      },
      selectedFood: null,
      isSelected: function(food) {
        var _ref;
        return ((_ref = this.selectedFood) != null ? _ref.NDB_No : void 0) === (food != null ? food.NDB_No : void 0);
      },
      toggle: function(food) {
        if (this.isSelected(food)) {
          return this.selectedFood = null;
        } else {
          return this.selectedFood = _.clone(food);
        }
      },
      basePath: "#/foods",
      updatePath: function() {
        return window.location.hash = this.getPath();
      },
      getPath: function(food) {
        if (food == null) {
          food = data.selectedFood;
        }
        return data.basePath + data.getSearch(food);
      },
      getSearch: function(food) {
        if (food == null) {
          food = data.selectedFood;
        }
        if (food) {
          return "?food=" + food.NDB_No;
        } else {
          return "";
        }
      }
    };
  });

  app.controller("FoodsCtrl", function($scope, $routeParams, FoodData, FoodsPage) {
    FoodData.afterLoading($scope, function() {
      if ($routeParams.food) {
        return FoodsPage.selectedFood = _.clone(FoodData.findFoodById($routeParams.food));
      } else {
        return FoodsPage.selectedFood = null;
      }
    });
    $scope.foods = FoodsPage;
    return $scope.$watch("foods.selectedFood", function(newVal, oldVal) {
      if (FoodData.loaded) {
        return FoodsPage.updatePath();
      }
    });
  });

  app.factory("NutrientsPage", function($location, FoodData) {
    var data;
    return data = {
      query: {
        text: "",
        includeFoodGroups: false
      },
      selectedNutrient: null,
      filteredFoods: FoodData.foods,
      isSelected: function(nutrient) {
        var _ref;
        return (nutrient != null ? nutrient.Nutr_No : void 0) === ((_ref = this.selectedNutrient) != null ? _ref.Nutr_No : void 0);
      },
      toggle: function(nutrient) {
        if (this.isSelected(nutrient)) {
          return this.selectedNutrient = null;
        } else {
          return this.selectedNutrient = _.clone(nutrient);
        }
      },
      orderBy: function(food) {
        var value;
        value = food.nutrientValue;
        if (value != null) {
          return value;
        } else {
          return -1;
        }
      },
      basePath: "#/nutrients",
      updatePath: function() {
        return window.location.hash = this.getPath();
      },
      getPath: function(nutrient) {
        if (nutrient == null) {
          nutrient = data.selectedNutrient;
        }
        return data.basePath + data.getSearch(nutrient);
      },
      getSearch: function(nutrient) {
        if (nutrient == null) {
          nutrient = data.selectedNutrient;
        }
        if (nutrient) {
          return "?nutrient=" + nutrient.Nutr_No;
        } else {
          return "";
        }
      }
    };
  });

  app.controller("NutrientsCtrl", function($scope, $routeParams, $filter, FoodData, NutrientsPage) {
    var calculateMaxValue, filteredFoodsWithoutValues, maxValue, updateFilteredFoods;
    FoodData.afterLoading($scope, function() {
      if ($routeParams.nutrient) {
        return NutrientsPage.selectedNutrient = _.clone(FoodData.findNutrientById($routeParams.nutrient));
      } else {
        return NutrientsPage.selectedNutrient = null;
      }
    });
    $scope.nutrients = NutrientsPage;
    filteredFoodsWithoutValues = null;
    maxValue = null;
    calculateMaxValue = function(nutrient) {
      var food, max, value, _i, _len;
      if (nutrient && filteredFoodsWithoutValues.length) {
        max = 0;
        for (_i = 0, _len = filteredFoodsWithoutValues.length; _i < _len; _i++) {
          food = filteredFoodsWithoutValues[_i];
          value = food[nutrient.NutrDesc];
          if (typeof value === "number" && value > max) {
            max = value;
          }
        }
        return max;
      } else {
        return null;
      }
    };
    updateFilteredFoods = function(applyFilter) {
      var selectedNutrient;
      if (!FoodData.loaded) {
        return;
      }
      if (applyFilter) {
        filteredFoodsWithoutValues = $filter("searchFoods")(FoodData.foods, $scope.nutrients.query);
      } else {
        if (filteredFoodsWithoutValues == null) {
          filteredFoodsWithoutValues = FoodData.foods;
        }
      }
      selectedNutrient = $scope.nutrients.selectedNutrient;
      maxValue = calculateMaxValue(selectedNutrient);
      $scope.nutrients.filteredFoods = selectedNutrient ? _.map(filteredFoodsWithoutValues, function(f) {
        var food;
        food = {
          NDB_No: f.NDB_No,
          Long_Desc: f.Long_Desc,
          FdGrp_Desc: f.FdGrp_Desc
        };
        food.nutrientValue = f[selectedNutrient.NutrDesc] || 0;
        food.nutrientPercentOfMax = maxValue ? ((food.nutrientValue / maxValue) * 100) + "%" : "0%";
        return food;
      }) : [];
      return NutrientsPage.updatePath();
    };
    $scope.$watch("nutrients.query.text", function(newVal, oldVal) {
      return updateFilteredFoods(true);
    });
    $scope.$watch("nutrients.selectedNutrient", function(newVal, oldVal) {
      return updateFilteredFoods();
    });
    $scope.$watch("nutrients.query.includeFoodGroups", function(newVal, oldVal) {
      return updateFilteredFoods(true);
    });
    return $scope.$watch("foodData.foods", function(newVal, oldVal) {
      return updateFilteredFoods(true);
    });
  });

  app.directive("foodSearch", function() {
    return {
      restrict: "E",
      templateUrl: "partials/food-search.html",
      scope: {
        foodData: "=",
        helpers: "="
      }
    };
  });

  app.directive("nutrientList", function(FoodData) {
    return {
      restrict: "E",
      templateUrl: "partials/nutrient-list.html",
      scope: {
        nutrientKeys: "=",
        helpers: "="
      },
      link: function(scope, element, attrs) {
        return scope.nutrients = _.map(scope.nutrientKeys, function(n) {
          return FoodData.nutrients[n];
        });
      }
    };
  });

  app.directive("foodGroupFilter", function(FoodData) {
    var supressEnableAllChange;
    supressEnableAllChange = false;
    return {
      restrict: "E",
      templateUrl: "partials/food-group-filter.html",
      scope: {
        foodData: "="
      },
      link: function(scope, element, attrs) {
        var onClick;
        onClick = function(e) {
          if (element.hasClass("open") && element !== e.target && !element.find(e.target).length) {
            scope.toggle();
          }
          return true;
        };
        FoodData.afterLoading(scope, function() {
          scope.foodGroups = FoodData.foodGroups;
          $(window).on("click", onClick);
          return scope.enableAllFoodGroups = FoodData.areAllFoodGroupsEnabled();
        });
        scope.toggle = function() {
          return element.toggleClass("open");
        };
        scope.$on("$destroy", function() {
          return $(window).off("click", onClick);
        });
        scope.$watch("foodGroups", function(newVal, oldVal) {
          FoodData.updateFoodGroups();
          if (scope.enableAllFoodGroups && FoodData.areAllFoodGroupsEnabled(oldVal) && !FoodData.areAllFoodGroupsEnabled(newVal) && FoodData.getFoodGroupsEnabledCount(newVal) > 0) {
            supressEnableAllChange = true;
            scope.enableAllFoodGroups = false;
          }
          if (!scope.enableAllFoodGroups && FoodData.areAllFoodGroupsEnabled(newVal) && !FoodData.areAllFoodGroupsEnabled(oldVal) && FoodData.getFoodGroupsEnabledCount(oldVal) > 0) {
            supressEnableAllChange = true;
            return scope.enableAllFoodGroups = true;
          }
        }, true);
        return scope.$watch("enableAllFoodGroups", function(newVal, oldVal) {
          var foodGroup, _i, _len, _ref, _results;
          if (supressEnableAllChange) {
            supressEnableAllChange = false;
            return;
          }
          if (newVal !== oldVal) {
            _ref = FoodData.foodGroups;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              foodGroup = _ref[_i];
              _results.push(foodGroup.enabled = newVal);
            }
            return _results;
          }
        });
      }
    };
  });

  app.filter("searchFoods", function() {
    return function(foods, query) {
      var filteredFoods, food, includeFoodGroups, matchCount, negativeRegExps, negativeSearchPrefixes, positiveRegExps, regExp, text, word, wordCount, words, _i, _j, _k, _l, _len, _len1, _len2, _len3;
      text = query.text, includeFoodGroups = query.includeFoodGroups;
      if (text && typeof text === "string") {
        text = text.replace(/[^a-zA-Z0-9.,% ]/g, "");
        filteredFoods = [];
        negativeSearchPrefixes = ["!", "-"];
        words = text.split(" ");
        words = _.reject(words, function(w) {
          return !w || w.length === 1 && _.contains(negativeSearchPrefixes, w);
        });
        wordCount = words.length;
        positiveRegExps = [];
        negativeRegExps = [];
        for (_i = 0, _len = words.length; _i < _len; _i++) {
          word = words[_i];
          if (!_.contains(negativeSearchPrefixes, word[0])) {
            positiveRegExps.push(new RegExp(word, "i"));
          } else {
            negativeRegExps.push(new RegExp(word.slice(1), "i"));
          }
        }
        for (_j = 0, _len1 = foods.length; _j < _len1; _j++) {
          food = foods[_j];
          matchCount = 0;
          for (_k = 0, _len2 = positiveRegExps.length; _k < _len2; _k++) {
            regExp = positiveRegExps[_k];
            if (food.Long_Desc.match(regExp) || (includeFoodGroups && food.FdGrp_Desc.match(regExp))) {
              matchCount += 1;
            }
          }
          for (_l = 0, _len3 = negativeRegExps.length; _l < _len3; _l++) {
            regExp = negativeRegExps[_l];
            if (!food.Long_Desc.match(regExp) && !(includeFoodGroups && food.FdGrp_Desc.match(regExp))) {
              matchCount += 1;
            }
          }
          if (wordCount === matchCount) {
            filteredFoods.push(food);
          }
        }
        return filteredFoods;
      } else {
        return foods;
      }
    };
  });

  app.filter("percent", function() {
    return function(number, decimals) {
      var multiple;
      if (decimals == null) {
        decimals = 0;
      }
      if (number != null) {
        multiple = Math.pow(10, decimals);
        return (Math.round(number * multiple * 100) / multiple) + "%";
      } else {
        return "";
      }
    };
  });

  app.directive("inputClearer", function() {
    return {
      link: function(scope, element, attrs) {
        var inputClearer;
        inputClearer = angular.element("<div class='input-clearer'>✕</div>");
        inputClearer.on("click", function() {
          return element.val("").focus().trigger("input");
        });
        return element.after(inputClearer);
      }
    };
  });

  data = angular.module("food-data", []);

  data.factory("FoodData", function($rootScope, Styles) {
    var FoodData, allFoods, allKeys, aminoAcidKeys, comparedKeys, keyAliases, loadCsvData, macronutrientKeys, mineralKeys, miscKeys, nutrientKeys, onLoadCbs, processFoods, processNutrients, setFoodGroups, sugarKeys, unusedKeys, vitaminKeys;
    allFoods = null;
    allKeys = ["NDB_No", "Long_Desc", "FdGrp_Desc", "10:0", "12:0", "13:0", "14:0", "14:1", "15:0", "15:1", "16:0", "16:1 c", "16:1 t", "16:1 undifferentiated", "17:0", "17:1", "18:0", "18:1 c", "18:1 t", "18:1 undifferentiated", "18:1-11t (18:1t n-7)", "18:2 CLAs", "18:2 i", "18:2 n-6 c,c", "18:2 t not further defined", "18:2 t,t", "18:2 undifferentiated", "18:3 n-3 c,c,c (ALA)", "18:3 n-6 c,c,c", "18:3 undifferentiated", "18:3i", "18:4", "20:0", "20:1", "20:2 n-6 c,c", "20:3 n-3", "20:3 n-6", "20:3 undifferentiated", "20:4 n-6", "20:4 undifferentiated", "20:5 n-3 (EPA)", "21:5", "22:0", "22:1 c", "22:1 t", "22:1 undifferentiated", "22:4", "22:5 n-3 (DPA)", "22:6 n-3 (DHA)", "24:0", "24:1 c", "4:0", "6:0", "8:0", "Adjusted Protein", "Alanine", "Alcohol, ethyl", "Arginine", "Ash", "Aspartic acid", "Betaine", "Beta-sitosterol", "Caffeine", "Calcium, Ca", "Campesterol", "Carbohydrate, by difference", "Carotene, alpha", "Carotene, beta", "Cholesterol", "Choline, total", "Copper, Cu", "Cryptoxanthin, beta", "Cystine", "Dihydrophylloquinone", "Energy", "Energy (kj)", "Fatty acids, total monounsaturated", "Fatty acids, total polyunsaturated", "Fatty acids, total saturated", "Fatty acids, total trans", "Fatty acids, total trans-monoenoic", "Fatty acids, total trans-polyenoic", "Fiber, total dietary", "Fluoride, F", "Folate, DFE", "Folate, food", "Folate, total", "Folic acid", "Fructose", "Galactose", "Glucose (dextrose)", "Glutamic acid", "Glycine", "Histidine", "Hydroxyproline", "Iron, Fe", "Isoleucine", "Lactose", "Leucine", "Lutein + zeaxanthin", "Lycopene", "Lysine", "Magnesium, Mg", "Maltose", "Manganese, Mn", "Menaquinone-4", "Methionine", "Niacin", "Pantothenic acid", "Phenylalanine", "Phosphorus, P", "Phytosterols", "Potassium, K", "Proline", "Protein", "Retinol", "Riboflavin", "Selenium, Se", "Serine", "Sodium, Na", "Starch", "Stigmasterol", "Sucrose", "Sugars, total", "Theobromine", "Thiamin", "Threonine", "Tocopherol, beta", "Tocopherol, delta", "Tocopherol, gamma", "Total lipid (fat)", "Tryptophan", "Tyrosine", "Valine", "Vitamin A, IU", "Vitamin A, RAE", "Vitamin B-12", "Vitamin B-12, added", "Vitamin B-6", "Vitamin C, total ascorbic acid", "Vitamin D", "Vitamin D (D2 + D3)", "Vitamin D2 (ergocalciferol)", "Vitamin D3 (cholecalciferol)", "Vitamin E (alpha-tocopherol)", "Vitamin E, added", "Vitamin K (phylloquinone)", "Water", "Zinc, Zn"];
    keyAliases = {
      "Total lipid (fat)": "Fat",
      "Carbohydrate, by difference": "Carbohydrate",
      "Fiber, total dietary": "Fiber",
      "Alcohol, ethyl": "Alcohol",
      "Vitamin A, RAE": "Vitamin A",
      "Vitamin C, total ascorbic acid": "Vitamin C",
      "Vitamin D (D2 + D3)": "Vitamin D",
      "Vitamin E (alpha-tocopherol)": "Vitamin E",
      "Vitamin K (phylloquinone)": "Vitamin K",
      "Folate, total": "Folate",
      "Choline, total": "Choline",
      "Calcium, Ca": "Calcium",
      "Iron, Fe": "Iron",
      "Magnesium, Mg": "Magnesium",
      "Manganese, Mn": "Manganese",
      "Phosphorus, P": "Phosphorus",
      "Potassium, K": "Potassium",
      "Sodium, Na": "Sodium",
      "Zinc, Zn": "Zinc",
      "Glucose (dextrose)": "Glucose"
    };
    comparedKeys = _.difference(allKeys, ["NDB_No", "Long_Desc", "FdGrp_Desc"]);
    macronutrientKeys = _.extend(["Total lipid (fat)", "Protein", "Carbohydrate, by difference", "Alcohol, ethyl"], {
      text: "Macronutrients"
    });
    miscKeys = _.extend(["Fiber, total dietary", "Lutein + zeaxanthin", "Choline, total"], {
      text: "Special",
      color: Styles.colors.yellow
    });
    vitaminKeys = _.extend(["Vitamin A, RAE", "Vitamin C, total ascorbic acid", "Vitamin D (D2 + D3)", "Vitamin E (alpha-tocopherol)", "Vitamin K (phylloquinone)", "Thiamin", "Riboflavin", "Niacin", "Pantothenic acid", "Vitamin B-6", "Folate, total", "Vitamin B-12"], {
      text: "Vitamins",
      color: Styles.colors.green
    });
    mineralKeys = _.extend(["Calcium, Ca", "Iron, Fe", "Magnesium, Mg", "Manganese, Mn", "Phosphorus, P", "Potassium, K", "Sodium, Na", "Zinc, Zn"], {
      text: "Minerals",
      color: Styles.colors.violet
    });
    aminoAcidKeys = _.extend(["Histidine", "Isoleucine", "Leucine", "Lysine", "Methionine", "Phenylalanine", "Threonine", "Tryptophan", "Valine"], {
      text: "Amino Acids",
      color: Styles.colors.blue
    });
    sugarKeys = _.extend(["Fructose", "Galactose", "Glucose (dextrose)", "Lactose", "Maltose", "Sucrose", "Sugars, total"], {
      text: "Sugars",
      color: Styles.colors.red
    });
    nutrientKeys = _.union(miscKeys, vitaminKeys, mineralKeys, aminoAcidKeys, sugarKeys);
    unusedKeys = _.difference(allKeys, macronutrientKeys, nutrientKeys);
    onLoadCbs = [];
    FoodData = {
      loaded: false,
      foods: null,
      nutrients: null,
      foodGroups: [],
      selectedFoods: [],
      macronutrientKeys: macronutrientKeys,
      nutrientKeys: nutrientKeys,
      miscKeys: miscKeys,
      vitaminKeys: vitaminKeys,
      mineralKeys: mineralKeys,
      aminoAcidKeys: aminoAcidKeys,
      sugarKeys: sugarKeys,
      findNutrientById: function(Nutr_No) {
        return _.find(this.nutrients, function(n) {
          return n.Nutr_No === Nutr_No;
        });
      },
      findFoodById: function(id) {
        return _.find(allFoods, function(f) {
          return f.NDB_No === id;
        });
      },
      findFoodsById: function(ids) {
        var id, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = ids.length; _i < _len; _i++) {
          id = ids[_i];
          _results.push(this.findFoodById(id));
        }
        return _results;
      },
      getNutrientJSLink: function(NutrDesc) {
        return "javascript: window.location = '" + (this.getNutrientLink(NutrDesc)) + "';";
      },
      getNutrientLink: function(NutrDesc) {
        return "#/nutrients?nutrient=" + this.nutrients[NutrDesc].Nutr_No;
      },
      updateFoodGroups: function() {
        var enabledFoodGroups;
        enabledFoodGroups = _.pluck(_.filter(this.foodGroups, function(g) {
          return g.enabled;
        }), "name");
        return this.foods = _.filter(allFoods, function(f) {
          return _.contains(enabledFoodGroups, f.FdGrp_Desc);
        });
      },
      areAllFoodGroupsEnabled: function(foodGroups) {
        if (foodGroups == null) {
          foodGroups = FoodData.foodGroups;
        }
        return !_.find(foodGroups, function(g) {
          return !g.enabled;
        });
      },
      getFoodGroupsEnabledCount: function(foodGroups) {
        if (foodGroups == null) {
          foodGroups = FoodData.foodGroups;
        }
        return _.filter(foodGroups, function(g) {
          return g.enabled;
        }).length;
      },
      calculateRelativeValues: function(foods) {
        var comparedKey, food, key, max, _i, _j, _len, _len1;
        for (_i = 0, _len = comparedKeys.length; _i < _len; _i++) {
          key = comparedKeys[_i];
          comparedKey = key + "_Compared";
          max = _.max(foods, function(f) {
            return f[key];
          })[key];
          for (_j = 0, _len1 = foods.length; _j < _len1; _j++) {
            food = foods[_j];
            if (food[key] != null) {
              food[comparedKey] = food[key] / max || 0;
            }
          }
        }
        return foods;
      },
      onLoad: function(cb, callIfLoaded) {
        if (callIfLoaded == null) {
          callIfLoaded = false;
        }
        if (!this.loaded) {
          return onLoadCbs.push(cb);
        } else if (callIfLoaded) {
          return cb();
        }
      },
      afterLoading: function(scope, cb) {
        if (this.loaded) {
          return cb();
        } else {
          return this.onLoad(function() {
            cb();
            return scope.$apply();
          });
        }
      }
    };
    loadCsvData = function(path, cb) {
      console.log("Loading .csv: ", path);
      return d3.csv(path, function(err, data) {
        if (err) {
          console.error(err);
        }
        return cb(data);
      });
    };
    processNutrients = function(rawNutrients) {
      var item, _i, _len;
      data = {};
      for (_i = 0, _len = rawNutrients.length; _i < _len; _i++) {
        item = rawNutrients[_i];
        data[item.NutrDesc] = item;
        item.text = keyAliases[item.NutrDesc] || item.NutrDesc;
      }
      return data;
    };
    processFoods = function(rawFoods) {
      var alcoholKey, calculatedCalorieKey, calorieKey, calories, carbohydrateKey, fatKey, ignoredKeys, item, k, proteinKey, v, _i, _len;
      for (_i = 0, _len = rawFoods.length; _i < _len; _i++) {
        item = rawFoods[_i];
        for (k in item) {
          v = item[k];
          if (_.contains(comparedKeys, k)) {
            if (v) {
              item[k] = parseFloat(v);
            } else {
              delete item[k];
            }
          }
        }
        calorieKey = "Energy";
        ignoredKeys = [calorieKey, "Energy (kj)", "Total lipid (fat)", "Protein", "Carbohydrate, by difference"];
        calories = item[calorieKey];
        for (k in item) {
          v = item[k];
          if (typeof v === "number" && !_.contains(ignoredKeys, k)) {
            if (calories) {
              item[k] = v / calories;
            } else {
              item[k] = -v;
            }
          }
        }
        calculatedCalorieKey = "Calories, calculated";
        fatKey = "Total lipid (fat)";
        proteinKey = "Protein";
        carbohydrateKey = "Carbohydrate, by difference";
        alcoholKey = "Alcohol, ethyl";
        item[fatKey] || (item[fatKey] = 0);
        item[proteinKey] || (item[proteinKey] = 0);
        item[carbohydrateKey] || (item[carbohydrateKey] = 0);
        item[alcoholKey] || (item[alcoholKey] = 0);
        item[fatKey] *= 9;
        item[proteinKey] *= 4;
        item[carbohydrateKey] *= 4;
        item[alcoholKey] *= 7;
        item[calculatedCalorieKey] = item[fatKey] + item[proteinKey] + item[carbohydrateKey] + item[alcoholKey];
        item[fatKey] /= item[calculatedCalorieKey];
        item[proteinKey] /= item[calculatedCalorieKey];
        item[carbohydrateKey] /= item[calculatedCalorieKey];
        item[alcoholKey] /= item[calculatedCalorieKey];
      }
      return rawFoods;
    };
    setFoodGroups = function(foods) {
      var food, foodGroups, group, i, _i, _j, _len, _len1;
      foodGroups = [];
      for (i = _i = 0, _len = foods.length; _i < _len; i = ++_i) {
        food = foods[i];
        if (!_.find(foodGroups, function(g) {
          return g.name === food.FdGrp_Desc;
        })) {
          foodGroups.push({
            name: food.FdGrp_Desc,
            id: "food-group-" + i,
            enabled: true
          });
        }
      }
      for (_j = 0, _len1 = foodGroups.length; _j < _len1; _j++) {
        group = foodGroups[_j];
        group.count = _.filter(foods, function(f) {
          return f.FdGrp_Desc === group.name;
        }).length;
      }
      return FoodData.foodGroups = foodGroups;
    };
    loadCsvData("data/nutrients.csv", function(rawNutrients) {
      FoodData.nutrients = processNutrients(rawNutrients);
      return loadCsvData("data/foods.csv", function(rawFoods) {
        var cb, _i, _len;
        FoodData.foods = allFoods = processFoods(rawFoods);
        setFoodGroups(FoodData.foods);
        FoodData.loaded = true;
        $rootScope.$apply();
        console.log("Loaded FoodData", FoodData);
        for (_i = 0, _len = onLoadCbs.length; _i < _len; _i++) {
          cb = onLoadCbs[_i];
          cb();
        }
        return onLoadCbs = null;
      });
    });
    return FoodData;
  });

  visuals = angular.module("food-visuals", []);

  visuals.factory("Styles", function() {
    var Styles, blue, blueViolet, comparisonRowHeight, green, greenBlue, rainbow, red, redYellow, violet, violetRed, yellow, yellowGreen;
    red = d3.rgb(255, 106, 97).toString();
    yellow = d3.rgb(255, 212, 113).toString();
    green = d3.rgb(148, 228, 109).toString();
    blue = d3.rgb(110, 210, 239).toString();
    violet = d3.rgb(208, 146, 244).toString();
    redYellow = d3.interpolateRgb(red, yellow)(0.5);
    yellowGreen = d3.interpolateRgb(yellow, green)(0.5);
    greenBlue = d3.interpolateRgb(green, blue)(0.5);
    blueViolet = d3.interpolateRgb(blue, violet)(0.5);
    violetRed = d3.interpolateRgb(violet, red)(0.5);
    rainbow = [green, greenBlue, blue, blueViolet, violet, violetRed, red, redYellow, yellow, yellowGreen];
    comparisonRowHeight = 46;
    return Styles = {
      smallFontSize: 12,
      smallFontLineHeight: 13,
      largeFontSize: 24,
      horizontalPadding: 6,
      comparisonHeaderHeight: 80,
      comparisonRowHeight: comparisonRowHeight,
      comparisonCellWidth: 20,
      comparisonHorizontalSpacing: 44,
      pieChartRadius: (comparisonRowHeight / 2) - 3,
      colors: {
        red: red,
        redYellow: redYellow,
        yellow: yellow,
        yellowGreen: yellowGreen,
        green: green,
        greenBlue: greenBlue,
        blue: blue,
        blueViolet: blueViolet,
        violet: violet,
        violetRed: violetRed,
        rainbow: rainbow,
        getRainbowColor: function(i) {
          var count;
          count = rainbow.length;
          while (i >= count) {
            i -= count;
          }
          return rainbow[i];
        },
        lightGray: "#bbb",
        blueText: d3.rgb(blue).darker(0.3),
        greenText: d3.rgb(green).darker(0.3),
        redText: d3.rgb(red).darker(0.3)
      }
    };
  });

  visuals.factory("DrawingHelpers", function(Styles, FoodData, $location) {
    var DrawingHelpers, drawNutrientGroups, drawNutrients, drawPieChart, drawPieCharts;
    drawPieChart = function(svg, data, radius, options) {
      var arc, arcs, g, pie, x, y;
      if (options == null) {
        options = {};
      }
      x = options.x, y = options.y;
      if (x == null) {
        x = radius;
      }
      if (y == null) {
        y = radius;
      }
      g = svg.append("g").data([data]).attr("transform", "translate(" + x + ", " + y + ")");
      arc = d3.svg.arc().outerRadius(radius);
      pie = d3.layout.pie().value(function(d) {
        return d.value;
      }).sort(function(d) {
        return data.indexOf(d);
      });
      arcs = g.selectAll("g.slice").data(pie).enter().append("g").attr("class", "slice");
      return arcs.append("path").attr("fill", function(d, i) {
        return d.data.color;
      }).attr("d", arc);
    };
    drawPieCharts = function(vis, foods) {
      var food, foodIndex, foodY, labelData, pieChartData, svg, _i, _ref, _results;
      svg = vis.append("svg").attr("height", vis.attr("height")).attr("width", (Styles.pieChartRadius * 2) + Styles.comparisonHorizontalSpacing);
      labelData = [
        {
          text: "Protein",
          color: Styles.colors.blueText,
          NutrDesc: "Protein"
        }, {
          text: "Carbs",
          color: Styles.colors.greenText,
          NutrDesc: "Carbohydrate, by difference"
        }, {
          text: "Fat",
          color: Styles.colors.redText,
          NutrDesc: "Total lipid (fat)"
        }
      ];
      svg.selectAll("text.pie-chart-legend-label").data(labelData).enter().append("text").attr("class", "pie-chart-legend-label nutrient-label").attr("x", (parseInt(svg.attr("width")) - Styles.comparisonHorizontalSpacing) / 2).attr("y", function(d, i) {
        return (i * Styles.smallFontLineHeight) + Styles.comparisonRowHeight;
      }).attr("text-anchor", "middle").style("font-size", Styles.smallFontSize).style("fill", function(d) {
        return d.color;
      }).text(function(d) {
        return d.text;
      }).attr("onclick", function(d) {
        return FoodData.getNutrientJSLink(d.NutrDesc);
      });
      _results = [];
      for (foodIndex = _i = 0, _ref = foods.length; 0 <= _ref ? _i < _ref : _i > _ref; foodIndex = 0 <= _ref ? ++_i : --_i) {
        food = foods[foodIndex];
        foodY = Styles.comparisonHeaderHeight + foodIndex * Styles.comparisonRowHeight;
        pieChartData = [
          {
            value: food["Total lipid (fat)"],
            color: Styles.colors.red
          }, {
            value: food["Protein"],
            color: Styles.colors.blue
          }, {
            value: food["Carbohydrate, by difference"],
            color: Styles.colors.green
          }, {
            value: food["Alcohol, ethyl"],
            color: Styles.colors.lightGray
          }
        ];
        _results.push(drawPieChart(svg, pieChartData, Styles.pieChartRadius, {
          x: Styles.pieChartRadius,
          y: foodY + Styles.pieChartRadius
        }));
      }
      return _results;
    };
    drawNutrients = function(vis, foods, nutrients) {
      var color, food, foodIndex, foodY, getLabelX, key, keyIndex, labelY, nutrientX, value, _i, _ref, _results;
      vis.append("text").attr("y", parseInt(vis.attr("height")) - 12).attr("x", (parseInt(vis.attr("width")) - Styles.comparisonHorizontalSpacing) / 2).attr("class", "nutrient-section-label").attr("text-anchor", "middle").style("font-size", Styles.largeFontSize).style("fill", nutrients.color).text((function() {
        switch (nutrients.text) {
          case "Special":
            return "";
          default:
            return nutrients.text;
        }
      })());
      getLabelX = function(i) {
        return i * Styles.comparisonCellWidth + 9;
      };
      labelY = Styles.comparisonHeaderHeight + Styles.horizontalPadding - 8;
      vis.selectAll("text.nutrient-label").data(nutrients).enter().append("text").attr("class", "nutrient-label").attr("transform", function(d, i) {
        return "rotate(-45 " + (getLabelX(i)) + " " + labelY + ")";
      }).attr("x", function(d, i) {
        return getLabelX(i);
      }).attr("y", labelY).style("font-size", Styles.smallFontSize).style("fill", function(d, i) {
        return Styles.colors.getRainbowColor(i);
      }).text(function(d) {
        return FoodData.nutrients[d].text;
      }).attr("onclick", function(d) {
        return FoodData.getNutrientJSLink(d);
      });
      _results = [];
      for (foodIndex = _i = 0, _ref = foods.length; 0 <= _ref ? _i < _ref : _i > _ref; foodIndex = 0 <= _ref ? ++_i : --_i) {
        food = foods[foodIndex];
        foodY = Styles.comparisonHeaderHeight + (foodIndex * Styles.comparisonRowHeight);
        _results.push((function() {
          var _j, _ref1, _results1;
          _results1 = [];
          for (keyIndex = _j = 0, _ref1 = nutrients.length; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; keyIndex = 0 <= _ref1 ? ++_j : --_j) {
            key = nutrients[keyIndex];
            value = food[key + "_Compared"];
            if (value == null) {
              continue;
            }
            color = Styles.colors.getRainbowColor(keyIndex);
            nutrientX = keyIndex * Styles.comparisonCellWidth;
            vis.append("rect").attr("x", nutrientX).attr("y", foodY).attr("width", Styles.comparisonCellWidth).attr("height", Styles.comparisonRowHeight).attr("fill", "#000").attr("opacity", 0.08).attr("title", key);
            _results1.push(vis.append("rect").attr("x", nutrientX + (Styles.comparisonCellWidth / 2) - ((Styles.comparisonCellWidth * value) / 2)).attr("y", foodY).attr("width", Styles.comparisonCellWidth * value).attr("height", Styles.comparisonRowHeight).attr("fill", color).attr("title", key));
          }
          return _results1;
        })());
      }
      return _results;
    };
    drawNutrientGroups = function(vis, foods, groups) {
      var nutrients, svg, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = groups.length; _i < _len; _i++) {
        nutrients = groups[_i];
        svg = vis.append("svg").attr("width", (nutrients.length * Styles.comparisonCellWidth) + Styles.comparisonHorizontalSpacing).attr("height", parseInt(vis.attr("height")));
        _results.push(DrawingHelpers.drawNutrients(svg, foods, nutrients));
      }
      return _results;
    };
    return DrawingHelpers = {
      drawPieChart: drawPieChart,
      drawPieCharts: drawPieCharts,
      drawNutrients: drawNutrients,
      drawNutrientGroups: drawNutrientGroups
    };
  });

  visuals.directive("foodComparison", function(Styles, FoodData, DrawingHelpers) {
    return {
      restrict: "E",
      templateUrl: "partials/food-comparison.html",
      link: function(scope, element, attrs) {
        var render, vis;
        vis = d3.select(element[0]).select(".food-comparison-graphs");
        render = function() {
          var foods, height, numSelected, nutrientGroups;
          vis.selectAll("*").remove();
          foods = scope.compare.selectedFoods;
          numSelected = foods.length;
          if (!numSelected) {
            vis.style("display", "none");
            return;
          }
          vis.style("display", "block");
          height = Styles.comparisonHeaderHeight + (Styles.comparisonRowHeight * (numSelected + 1));
          vis.attr("height", height);
          DrawingHelpers.drawPieCharts(vis, foods);
          nutrientGroups = [FoodData.miscKeys, FoodData.vitaminKeys, FoodData.mineralKeys, FoodData.aminoAcidKeys, FoodData.sugarKeys];
          return DrawingHelpers.drawNutrientGroups(vis, foods, nutrientGroups);
        };
        return scope.$watch("compare.selectedFoods.length", function() {
          return render();
        });
      }
    };
  });

  visuals.directive("foodDetail", function(Styles, FoodData, DrawingHelpers, ComparePage) {
    return {
      restrict: "E",
      templateUrl: "partials/food-detail.html",
      scope: {
        foodData: "=",
        food: "="
      },
      link: function(scope, element, attrs) {
        var render, vis;
        vis = d3.select(element[0]).select(".food-detail-graph");
        render = function() {
          var food, pieChart, pieChartData, pieChartRadius;
          vis.selectAll("*").remove();
          food = scope.food;
          if (!food) {
            return;
          }
          pieChartData = [
            {
              value: food["Total lipid (fat)"],
              color: Styles.colors.red
            }, {
              value: food["Protein"],
              color: Styles.colors.blue
            }, {
              value: food["Carbohydrate, by difference"],
              color: Styles.colors.green
            }, {
              value: food["Alcohol, ethyl"],
              color: Styles.colors.lightGray
            }
          ];
          pieChartRadius = 100;
          pieChart = vis.append("svg").attr("height", pieChartRadius * 2).attr("width", pieChartRadius * 2);
          return DrawingHelpers.drawPieChart(pieChart, pieChartData, pieChartRadius);
        };
        scope.$watch("food", function() {
          return render();
        });
        return scope.getCompareLink = function(food) {
          return ComparePage.getPathWithFoodAdded(food);
        };
      }
    };
  });

}).call(this);
